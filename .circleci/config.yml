defaults: &defaults
  working_directory: /home/nerves/build
  docker:
    - image: nervesproject/toolchains

build: &build
  

build_workflow: &build_workflow
  context: org-global
  filters:
    tags:
      only: /.*/

deploy_workflow: &deploy_workflow
  context: org-global
  filters:
    branches:
      ignore: /.*/
    tags:
      only: /v.*/

canadian_rpi: &canadian_rpi
  HOST_OS: linux
  HOST_ARCH: arm

version: 2.0

jobs:
  #-------------------------------
  # aarch64_unknown_linux_gnueabi
  #-------------------------------
  # build
  #  linux
  build_linux_nerves_toolchain_aarch64_unknown_linux_gnueabi:
    <<: *defaults
    environment:
      TOOLCHAIN: nerves_toolchain_aarch64_unknown_linux_gnueabi
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          key: nerves/dl/nerves_toolchain_aarch64_unknown_linux_gnueabi/linux-{{ .Branch }}
      - run:
          name: Build
          command: ./nerves_toolchain_ctng/build.sh $TOOLCHAIN
      - run:
          name: "Create artifact dir"
          command: mkdir -p /home/nerves/deploy/toolchain/nerves_toolchain_aarch64_unknown_linux_gnueabi/linux
      - save_cache:
          key: nerves/dl/nerves_toolchain_aarch64_unknown_linux_gnueabi/linux-{{ .Branch }}
          paths:
            - $HOME/.nerves/dl
      - run:
          name: "Copy Artifacts"
          command: cp ${TOOLCHAIN}*.tar.xz /home/nerves/deploy/toolchain/nerves_toolchain_aarch64_unknown_linux_gnueabi/linux
      - store_artifacts:
          path: /home/nerves/deploy/toolchain/nerves_toolchain_aarch64_unknown_linux_gnueabi/linux
          destination: toolchain
      - save_cache:
          key: nerves/build/nerves_toolchain_aarch64_unknown_linux_gnueabi/linux-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - /home/nerves/build
      - save_cache:
          key: nerves/deploy/nerves_toolchain_aarch64_unknown_linux_gnueabi/linux-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - /home/nerves/deploy/toolchain/nerves_toolchain_aarch64_unknown_linux_gnueabi/linux
  #  rpi
  build_rpi_nerves_toolchain_aarch64_unknown_linux_gnueabi:
    <<: *defaults
    environment:
      TOOLCHAIN: nerves_toolchain_aarch64_unknown_linux_gnueabi
      <<: *canadian_rpi
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          key: nerves/dl/nerves_toolchain_aarch64_unknown_linux_gnueabi/rpi-{{ .Branch }}
      - run:
          name: Update Path
          command: |
            echo 'export PATH=$HOME/build/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin:$PATH' >> $BASH_ENV
            source $BASH_ENV
      - run:
          name: Fetch Dependencies
          command: git clone git://github.com/raspberrypi/tools.git
      - run:
          name: Build
          command: ./nerves_toolchain_ctng/build.sh $TOOLCHAIN
      - run:
          name: "Create artifact dir"
          command: mkdir -p /home/nerves/deploy/toolchain/nerves_toolchain_aarch64_unknown_linux_gnueabi/rpi
      - save_cache:
          key: nerves/dl/nerves_toolchain_aarch64_unknown_linux_gnueabi/rpi-{{ .Branch }}
          paths:
            - $HOME/.nerves/dl
      - run:
          name: "Copy Artifacts"
          command: cp ${TOOLCHAIN}*.tar.xz /home/nerves/deploy/toolchain/nerves_toolchain_aarch64_unknown_linux_gnueabi/rpi
      - store_artifacts:
          path: /home/nerves/deploy/toolchain/nerves_toolchain_aarch64_unknown_linux_gnueabi/rpi
          destination: toolchain
      - save_cache:
          key: nerves/build/nerves_toolchain_aarch64_unknown_linux_gnueabi/rpi-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/build"
      - save_cache:
          key: nerves/deploy/nerves_toolchain_aarch64_unknown_linux_gnueabi/rpi-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/deploy/toolchain/nerves_toolchain_aarch64_unknown_linux_gnueabi/rpi"
    
  
  #-------------------------------
  # arm_unknown_linux_gnueabihf
  #-------------------------------
  # build
  #  linux
  build_linux_nerves_toolchain_arm_unknown_linux_gnueabihf:
    <<: *defaults
    environment:
      TOOLCHAIN: nerves_toolchain_arm_unknown_linux_gnueabihf
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          key: nerves/dl/nerves_toolchain_arm_unknown_linux_gnueabihf/linux-{{ .Branch }}
      - run:
          name: Build
          command: ./nerves_toolchain_ctng/build.sh $TOOLCHAIN
      - run:
          name: "Create artifact dir"
          command: mkdir -p /home/nerves/deploy/toolchain/nerves_toolchain_arm_unknown_linux_gnueabihf/linux
      - save_cache:
          key: nerves/dl/nerves_toolchain_arm_unknown_linux_gnueabihf/linux-{{ .Branch }}
          paths:
            - $HOME/.nerves/dl
      - run:
          name: "Copy Artifacts"
          command: cp ${TOOLCHAIN}*.tar.xz /home/nerves/deploy/toolchain/nerves_toolchain_arm_unknown_linux_gnueabihf/linux
      - store_artifacts:
          path: /home/nerves/deploy/toolchain/nerves_toolchain_arm_unknown_linux_gnueabihf/linux
          destination: toolchain
      - save_cache:
          key: nerves/build/nerves_toolchain_arm_unknown_linux_gnueabihf/linux-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/build"
      - save_cache:
          key: nerves/deploy/nerves_toolchain_arm_unknown_linux_gnueabihf/linux-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/deploy/toolchain/nerves_toolchain_arm_unknown_linux_gnueabihf/linux"
  #  rpi
  build_rpi_nerves_toolchain_arm_unknown_linux_gnueabihf:
    <<: *defaults
    environment:
      TOOLCHAIN: nerves_toolchain_arm_unknown_linux_gnueabihf
      <<: *canadian_rpi
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          key: nerves/dl/nerves_toolchain_arm_unknown_linux_gnueabihf/rpi-{{ .Branch }}
      - run:
          name: Update Path
          command: |
            echo 'export PATH=$HOME/build/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin:$PATH' >> $BASH_ENV
            source $BASH_ENV
      - run:
          name: Fetch Dependencies
          command: git clone git://github.com/raspberrypi/tools.git
      - run:
          name: Build
          command: ./nerves_toolchain_ctng/build.sh $TOOLCHAIN
      - run:
          name: "Create artifact dir"
          command: mkdir -p /home/nerves/deploy/toolchain/nerves_toolchain_arm_unknown_linux_gnueabihf/rpi
      - save_cache:
          key: nerves/dl/nerves_toolchain_arm_unknown_linux_gnueabihf/rpi-{{ .Branch }}
          paths:
            - $HOME/.nerves/dl
      - run:
          name: "Copy Artifacts"
          command: cp ${TOOLCHAIN}*.tar.xz /home/nerves/deploy/toolchain/nerves_toolchain_arm_unknown_linux_gnueabihf/rpi
      - store_artifacts:
          path: /home/nerves/deploy/toolchain/nerves_toolchain_arm_unknown_linux_gnueabihf/rpi
          destination: toolchain
      - save_cache:
          key: nerves/build/nerves_toolchain_arm_unknown_linux_gnueabihf/rpi-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/build"
      - save_cache:
          key: nerves/deploy/nerves_toolchain_arm_unknown_linux_gnueabihf/rpi-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/deploy/toolchain/nerves_toolchain_arm_unknown_linux_gnueabihf/rpi"

  #-------------------------------
  # armv5tejl_unknown_linux_musleabi
  #-------------------------------
  # build
  #  linux
  build_linux_nerves_toolchain_armv5tejl_unknown_linux_musleabi:
    <<: *defaults
    environment:
      TOOLCHAIN: nerves_toolchain_armv5tejl_unknown_linux_musleabi
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          key: nerves/dl/nerves_toolchain_armv5tejl_unknown_linux_musleabi/linux-{{ .Branch }}
      - run:
          name: Build
          command: ./nerves_toolchain_ctng/build.sh $TOOLCHAIN
      - run:
          name: "Create artifact dir"
          command: mkdir -p /home/nerves/deploy/toolchain/nerves_toolchain_armv5tejl_unknown_linux_musleabi/linux
      - save_cache:
          key: nerves/dl/nerves_toolchain_armv5tejl_unknown_linux_musleabi/linux-{{ .Branch }}
          paths:
            - $HOME/.nerves/dl
      - run:
          name: "Copy Artifacts"
          command: cp ${TOOLCHAIN}*.tar.xz /home/nerves/deploy/toolchain/nerves_toolchain_armv5tejl_unknown_linux_musleabi/linux
      - store_artifacts:
          path: /home/nerves/deploy/toolchain/nerves_toolchain_armv5tejl_unknown_linux_musleabi/linux
          destination: toolchain
      - save_cache:
          key: nerves/build/nerves_toolchain_armv5tejl_unknown_linux_musleabi/linux-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/build"
      - save_cache:
          key: nerves/deploy/nerves_toolchain_armv5tejl_unknown_linux_musleabi/linux-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/deploy/toolchain/nerves_toolchain_armv5tejl_unknown_linux_musleabi/linux"
  #  rpi
  build_rpi_nerves_toolchain_armv5tejl_unknown_linux_musleabi:
    <<: *defaults
    environment:
      TOOLCHAIN: nerves_toolchain_armv5tejl_unknown_linux_musleabi
      <<: *canadian_rpi
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          key: nerves/dl/nerves_toolchain_armv5tejl_unknown_linux_musleabi/rpi-{{ .Branch }}
      - run:
          name: Update Path
          command: |
            echo 'export PATH=$HOME/build/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin:$PATH' >> $BASH_ENV
            source $BASH_ENV
      - run:
          name: Fetch Dependencies
          command: git clone git://github.com/raspberrypi/tools.git
      - run:
          name: Build
          command: ./nerves_toolchain_ctng/build.sh $TOOLCHAIN
      - run:
          name: "Create artifact dir"
          command: mkdir -p /home/nerves/deploy/toolchain/nerves_toolchain_armv5tejl_unknown_linux_musleabi/rpi
      - save_cache:
          key: nerves/dl/nerves_toolchain_armv5tejl_unknown_linux_musleabi/rpi-{{ .Branch }}
          paths:
            - $HOME/.nerves/dl
      - run:
          name: "Copy Artifacts"
          command: cp ${TOOLCHAIN}*.tar.xz /home/nerves/deploy/toolchain/nerves_toolchain_armv5tejl_unknown_linux_musleabi/rpi
      - store_artifacts:
          path: /home/nerves/deploy/toolchain/nerves_toolchain_armv5tejl_unknown_linux_musleabi/rpi
          destination: toolchain
      - save_cache:
          key: nerves/build/nerves_toolchain_armv5tejl_unknown_linux_musleabi/rpi-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/build"
      - save_cache:
          key: nerves/deploy/nerves_toolchain_armv5tejl_unknown_linux_musleabi/rpi-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/deploy/toolchain/nerves_toolchain_armv5tejl_unknown_linux_musleabi/rpi"

  #-------------------------------
  # armv6_rpi_linux_gnueabi
  #-------------------------------
  # build
  #  linux
  build_linux_nerves_toolchain_armv6_rpi_linux_gnueabi:
    <<: *defaults
    environment:
      TOOLCHAIN: nerves_toolchain_armv6_rpi_linux_gnueabi
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          key: nerves/dl/nerves_toolchain_armv6_rpi_linux_gnueabi/linux-{{ .Branch }}
      - run:
          name: Build
          command: ./nerves_toolchain_ctng/build.sh $TOOLCHAIN
      - run:
          name: "Create artifact dir"
          command: mkdir -p /home/nerves/deploy/toolchain/nerves_toolchain_armv6_rpi_linux_gnueabi/linux
      - save_cache:
          key: nerves/dl/nerves_toolchain_armv6_rpi_linux_gnueabi/linux-{{ .Branch }}
          paths:
            - $HOME/.nerves/dl
      - run:
          name: "Copy Artifacts"
          command: cp ${TOOLCHAIN}*.tar.xz /home/nerves/deploy/toolchain/nerves_toolchain_armv6_rpi_linux_gnueabi/linux
      - store_artifacts:
          path: /home/nerves/deploy/toolchain/nerves_toolchain_armv6_rpi_linux_gnueabi/linux
          destination: toolchain
      - save_cache:
          key: nerves/build/nerves_toolchain_armv6_rpi_linux_gnueabi/linux-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/build"
      - save_cache:
          key: nerves/deploy/nerves_toolchain_armv6_rpi_linux_gnueabi/linux-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/deploy/toolchain/nerves_toolchain_armv6_rpi_linux_gnueabi/linux"
  #  rpi
  build_rpi_nerves_toolchain_armv6_rpi_linux_gnueabi:
    <<: *defaults
    environment:
      TOOLCHAIN: nerves_toolchain_armv6_rpi_linux_gnueabi
      <<: *canadian_rpi
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          key: nerves/dl/nerves_toolchain_armv6_rpi_linux_gnueabi/rpi-{{ .Branch }}
      - run:
          name: Update Path
          command: |
            echo 'export PATH=$HOME/build/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin:$PATH' >> $BASH_ENV
            source $BASH_ENV
      - run:
          name: Fetch Dependencies
          command: git clone git://github.com/raspberrypi/tools.git
      - run:
          name: Build
          command: ./nerves_toolchain_ctng/build.sh $TOOLCHAIN
      - run:
          name: "Create artifact dir"
          command: mkdir -p /home/nerves/deploy/toolchain/nerves_toolchain_armv6_rpi_linux_gnueabi/rpi
      - save_cache:
          key: nerves/dl/nerves_toolchain_armv6_rpi_linux_gnueabi/rpi-{{ .Branch }}
          paths:
            - $HOME/.nerves/dl
      - run:
          name: "Copy Artifacts"
          command: cp ${TOOLCHAIN}*.tar.xz /home/nerves/deploy/toolchain/nerves_toolchain_armv6_rpi_linux_gnueabi/rpi
      - store_artifacts:
          path: /home/nerves/deploy/toolchain/nerves_toolchain_armv6_rpi_linux_gnueabi/rpi
          destination: toolchain
      - save_cache:
          key: nerves/build/nerves_toolchain_armv6_rpi_linux_gnueabi/rpi-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/build"
      - save_cache:
          key: nerves/deploy/nerves_toolchain_armv6_rpi_linux_gnueabi/rpi-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/deploy/toolchain/nerves_toolchain_armv6_rpi_linux_gnueabi/rpi"

  #-------------------------------
  # i586_unknown_linux_gnu
  #-------------------------------
  # build
  #  linux
  build_linux_nerves_toolchain_i586_unknown_linux_gnu:
    <<: *defaults
    environment:
      TOOLCHAIN: nerves_toolchain_i586_unknown_linux_gnu
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          key: nerves/dl/nerves_toolchain_i586_unknown_linux_gnu/linux-{{ .Branch }}
      - run:
          name: Build
          command: ./nerves_toolchain_ctng/build.sh $TOOLCHAIN
      - run:
          name: "Create artifact dir"
          command: mkdir -p /home/nerves/deploy/toolchain/nerves_toolchain_i586_unknown_linux_gnu/linux
      - save_cache:
          key: nerves/dl/nerves_toolchain_i586_unknown_linux_gnu/linux-{{ .Branch }}
          paths:
            - $HOME/.nerves/dl
      - run:
          name: "Copy Artifacts"
          command: cp ${TOOLCHAIN}*.tar.xz /home/nerves/deploy/toolchain/nerves_toolchain_i586_unknown_linux_gnu/linux
      - store_artifacts:
          path: /home/nerves/deploy/toolchain/nerves_toolchain_i586_unknown_linux_gnu/linux
          destination: toolchain
      - save_cache:
          key: nerves/build/nerves_toolchain_i586_unknown_linux_gnu/linux-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/build"
      - save_cache:
          key: nerves/deploy/nerves_toolchain_i586_unknown_linux_gnu/linux-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/deploy/toolchain/nerves_toolchain_i586_unknown_linux_gnu/linux"
  #  rpi
  build_rpi_nerves_toolchain_i586_unknown_linux_gnu:
    <<: *defaults
    environment:
      TOOLCHAIN: nerves_toolchain_i586_unknown_linux_gnu
      <<: *canadian_rpi
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          key: nerves/dl/nerves_toolchain_i586_unknown_linux_gnu/rpi-{{ .Branch }}
      - run:
          name: Update Path
          command: |
            echo 'export PATH=$HOME/build/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin:$PATH' >> $BASH_ENV
            source $BASH_ENV
      - run:
          name: Fetch Dependencies
          command: git clone git://github.com/raspberrypi/tools.git
      - run:
          name: Build
          command: ./nerves_toolchain_ctng/build.sh $TOOLCHAIN
      - run:
          name: "Create artifact dir"
          command: mkdir -p /home/nerves/deploy/toolchain/nerves_toolchain_i586_unknown_linux_gnu/rpi
      - save_cache:
          key: nerves/dl/nerves_toolchain_i586_unknown_linux_gnu/rpi-{{ .Branch }}
          paths:
            - $HOME/.nerves/dl
      - run:
          name: "Copy Artifacts"
          command: cp ${TOOLCHAIN}*.tar.xz /home/nerves/deploy/toolchain/nerves_toolchain_i586_unknown_linux_gnu/rpi
      - store_artifacts:
          path: /home/nerves/deploy/toolchain/nerves_toolchain_i586_unknown_linux_gnu/rpi
          destination: toolchain
      - save_cache:
          key: nerves/build/nerves_toolchain_i586_unknown_linux_gnu/rpi-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/build"
      - save_cache:
          key: nerves/deploy/nerves_toolchain_i586_unknown_linux_gnu/rpi-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/deploy/toolchain/nerves_toolchain_i586_unknown_linux_gnu/rpi"

  #-------------------------------
  # mipsel_unknown_linux_musl
  #-------------------------------
  # build
  #  linux
  build_linux_nerves_toolchain_mipsel_unknown_linux_musl:
    <<: *defaults
    environment:
      TOOLCHAIN: nerves_toolchain_mipsel_unknown_linux_musl
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          key: nerves/dl/nerves_toolchain_mipsel_unknown_linux_musl/linux-{{ .Branch }}
      - run:
          name: Build
          command: ./nerves_toolchain_ctng/build.sh $TOOLCHAIN
      - run:
          name: "Create artifact dir"
          command: mkdir -p /home/nerves/deploy/toolchain/nerves_toolchain_mipsel_unknown_linux_musl/linux
      - save_cache:
          key: nerves/dl/nerves_toolchain_mipsel_unknown_linux_musl/linux-{{ .Branch }}
          paths:
            - $HOME/.nerves/dl
      - run:
          name: "Copy Artifacts"
          command: cp ${TOOLCHAIN}*.tar.xz /home/nerves/deploy/toolchain/nerves_toolchain_mipsel_unknown_linux_musl/linux
      - store_artifacts:
          path: /home/nerves/deploy/toolchain/nerves_toolchain_mipsel_unknown_linux_musl/linux
          destination: toolchain
      - save_cache:
          key: nerves/build/nerves_toolchain_mipsel_unknown_linux_musl/linux-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/build"
      - save_cache:
          key: nerves/deploy/nerves_toolchain_mipsel_unknown_linux_musl/linux-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/deploy/toolchain/nerves_toolchain_mipsel_unknown_linux_musl/linux"
  #  rpi
  build_rpi_nerves_toolchain_mipsel_unknown_linux_musl:
    <<: *defaults
    environment:
      TOOLCHAIN: nerves_toolchain_mipsel_unknown_linux_musl
      <<: *canadian_rpi
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          key: nerves/dl/nerves_toolchain_mipsel_unknown_linux_musl/rpi-{{ .Branch }}
      - run:
          name: Update Path
          command: |
            echo 'export PATH=$HOME/build/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin:$PATH' >> $BASH_ENV
            source $BASH_ENV
      - run:
          name: Fetch Dependencies
          command: git clone git://github.com/raspberrypi/tools.git
      - run:
          name: Build
          command: ./nerves_toolchain_ctng/build.sh $TOOLCHAIN
      - run:
          name: "Create artifact dir"
          command: mkdir -p /home/nerves/deploy/toolchain/nerves_toolchain_mipsel_unknown_linux_musl/rpi
      - save_cache:
          key: nerves/dl/nerves_toolchain_mipsel_unknown_linux_musl/rpi-{{ .Branch }}
          paths:
            - $HOME/.nerves/dl
      - run:
          name: "Copy Artifacts"
          command: cp ${TOOLCHAIN}*.tar.xz /home/nerves/deploy/toolchain/nerves_toolchain_mipsel_unknown_linux_musl/rpi
      - store_artifacts:
          path: /home/nerves/deploy/toolchain/nerves_toolchain_mipsel_unknown_linux_musl/rpi
          destination: toolchain
      - save_cache:
          key: nerves/build/nerves_toolchain_mipsel_unknown_linux_musl/rpi-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/build"
      - save_cache:
          key: nerves/deploy/nerves_toolchain_mipsel_unknown_linux_musl/rpi-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/deploy/toolchain/nerves_toolchain_mipsel_unknown_linux_musl/rpi"

  #-------------------------------
  # x86_64_unknown_linux_gnu
  #-------------------------------
  # build
  #  linux
  build_linux_nerves_toolchain_x86_64_unknown_linux_gnu:
    <<: *defaults
    environment:
      TOOLCHAIN: nerves_toolchain_x86_64_unknown_linux_gnu
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          key: nerves/dl/nerves_toolchain_x86_64_unknown_linux_gnu/linux-{{ .Branch }}
      - run:
          name: Build
          command: ./nerves_toolchain_ctng/build.sh $TOOLCHAIN
      - run:
          name: "Create artifact dir"
          command: mkdir -p /home/nerves/deploy/toolchain/nerves_toolchain_x86_64_unknown_linux_gnu/linux
      - save_cache:
          key: nerves/dl/nerves_toolchain_x86_64_unknown_linux_gnu/linux-{{ .Branch }}
          paths:
            - $HOME/.nerves/dl
      - run:
          name: "Copy Artifacts"
          command: cp ${TOOLCHAIN}*.tar.xz /home/nerves/deploy/toolchain/nerves_toolchain_x86_64_unknown_linux_gnu/linux
      - store_artifacts:
          path: /home/nerves/deploy/toolchain/nerves_toolchain_x86_64_unknown_linux_gnu/linux
          destination: toolchain
      - save_cache:
          key: nerves/build/nerves_toolchain_x86_64_unknown_linux_gnu/linux-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/build"
      - save_cache:
          key: nerves/deploy/nerves_toolchain_x86_64_unknown_linux_gnu/linux-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/deploy/toolchain/nerves_toolchain_x86_64_unknown_linux_gnu/linux"
  #  rpi
  build_rpi_nerves_toolchain_x86_64_unknown_linux_gnu:
    <<: *defaults
    environment:
      TOOLCHAIN: nerves_toolchain_x86_64_unknown_linux_gnu
      <<: *canadian_rpi
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          key: nerves/dl/nerves_toolchain_x86_64_unknown_linux_gnu/rpi-{{ .Branch }}
      - run:
          name: Update Path
          command: |
            echo 'export PATH=$HOME/build/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin:$PATH' >> $BASH_ENV
            source $BASH_ENV
      - run:
          name: Fetch Dependencies
          command: git clone git://github.com/raspberrypi/tools.git
      - run:
          name: Build
          command: ./nerves_toolchain_ctng/build.sh $TOOLCHAIN
      - run:
          name: "Create artifact dir"
          command: mkdir -p /home/nerves/deploy/toolchain/nerves_toolchain_x86_64_unknown_linux_gnu/rpi
      - save_cache:
          key: nerves/dl/nerves_toolchain_x86_64_unknown_linux_gnu/rpi-{{ .Branch }}
          paths:
            - $HOME/.nerves/dl
      - run:
          name: "Copy Artifacts"
          command: cp ${TOOLCHAIN}*.tar.xz /home/nerves/deploy/toolchain/nerves_toolchain_x86_64_unknown_linux_gnu/rpi
      - store_artifacts:
          path: /home/nerves/deploy/toolchain/nerves_toolchain_x86_64_unknown_linux_gnu/rpi
          destination: toolchain
      - save_cache:
          key: nerves/build/nerves_toolchain_x86_64_unknown_linux_gnu/rpi-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/build"
      - save_cache:
          key: nerves/deploy/nerves_toolchain_x86_64_unknown_linux_gnu/rpi-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/deploy/toolchain/nerves_toolchain_x86_64_unknown_linux_gnu/rpi"

  #-------------------------------
  # x86_64_unknown_linux_musl
  #-------------------------------
  # build
  #  linux
  build_linux_nerves_toolchain_x86_64_unknown_linux_musl:
    <<: *defaults
    environment:
      TOOLCHAIN: nerves_toolchain_x86_64_unknown_linux_musl
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          key: nerves/dl/nerves_toolchain_x86_64_unknown_linux_musl/linux-{{ .Branch }}
      - run:
          name: Build
          command: ./nerves_toolchain_ctng/build.sh $TOOLCHAIN
      - run:
          name: "Create artifact dir"
          command: mkdir -p /home/nerves/deploy/toolchain/nerves_toolchain_x86_64_unknown_linux_musl/linux
      - save_cache:
          key: nerves/dl/nerves_toolchain_x86_64_unknown_linux_musl/linux-{{ .Branch }}
          paths:
            - $HOME/.nerves/dl
      - run:
          name: "Copy Artifacts"
          command: cp ${TOOLCHAIN}*.tar.xz /home/nerves/deploy/toolchain/nerves_toolchain_x86_64_unknown_linux_musl/linux
      - store_artifacts:
          path: /home/nerves/deploy/toolchain/nerves_toolchain_x86_64_unknown_linux_musl/linux
          destination: toolchain
      - save_cache:
          key: nerves/build/nerves_toolchain_x86_64_unknown_linux_musl/linux-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/build"
      - save_cache:
          key: nerves/deploy/nerves_toolchain_x86_64_unknown_linux_musl/linux-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/deploy/toolchain/nerves_toolchain_x86_64_unknown_linux_musl/linux"
  #  rpi
  build_rpi_nerves_toolchain_x86_64_unknown_linux_musl:
    <<: *defaults
    environment:
      TOOLCHAIN: nerves_toolchain_x86_64_unknown_linux_musl
      <<: *canadian_rpi
    resource_class: large
    steps:
      - checkout
      - restore_cache:
          key: nerves/dl/nerves_toolchain_x86_64_unknown_linux_musl/rpi-{{ .Branch }}
      - run:
          name: Update Path
          command: |
            echo 'export PATH=$HOME/build/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin:$PATH' >> $BASH_ENV
            source $BASH_ENV
      - run:
          name: Fetch Dependencies
          command: git clone git://github.com/raspberrypi/tools.git
      - run:
          name: Build
          command: ./nerves_toolchain_ctng/build.sh $TOOLCHAIN
      - run:
          name: "Create artifact dir"
          command: mkdir -p /home/nerves/deploy/toolchain/nerves_toolchain_x86_64_unknown_linux_musl/rpi
      - save_cache:
          key: nerves/dl/nerves_toolchain_x86_64_unknown_linux_musl/rpi-{{ .Branch }}
          paths:
            - $HOME/.nerves/dl
      - run:
          name: "Copy Artifacts"
          command: cp ${TOOLCHAIN}*.tar.xz /home/nerves/deploy/toolchain/nerves_toolchain_x86_64_unknown_linux_musl/rpi
      - store_artifacts:
          path: /home/nerves/deploy/toolchain/nerves_toolchain_x86_64_unknown_linux_musl/rpi
          destination: toolchain
      - save_cache:
          key: nerves/build/nerves_toolchain_x86_64_unknown_linux_musl/rpi-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/build"
      - save_cache:
          key: nerves/deploy/nerves_toolchain_x86_64_unknown_linux_musl/rpi-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
          paths:
            - "/home/nerves/deploy/toolchain/nerves_toolchain_x86_64_unknown_linux_musl/rpi"
  
  deploy:
    <<: *defaults
    steps:
    - checkout
    - run:
        name: Create Artifacts Dir
        command: mkdir -p /home/nerves/deploy/artifacts
    - restore_cache:
        key: nerves/deploy/nerves_toolchain_aarch64_unknown_linux_gnueabi/linux-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
    - restore_cache:
        key: nerves/deploy/nerves_toolchain_aarch64_unknown_linux_gnueabi/rpi-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
    - restore_cache:
        key: nerves/deploy/nerves_toolchain_arm_unknown_linux_gnueabihf/linux-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
    - restore_cache:
        key: nerves/deploy/nerves_toolchain_arm_unknown_linux_gnueabihf/rpi-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
    - restore_cache:
        key: nerves/deploy/nerves_toolchain_armv5tejl_unknown_linux_musleabi/linux-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
    - restore_cache:
        key: nerves/deploy/nerves_toolchain_armv5tejl_unknown_linux_musleabi/rpi-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
    - restore_cache:
        key: nerves/deploy/nerves_toolchain_armv6_rpi_linux_gnueabi/linux-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
    - restore_cache:
        key: nerves/deploy/nerves_toolchain_armv6_rpi_linux_gnueabi/rpi-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
    - restore_cache:
        key: nerves/deploy/nerves_toolchain_i586_unknown_linux_gnu/linux-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
    - restore_cache:
        key: nerves/deploy/nerves_toolchain_i586_unknown_linux_gnu/rpi-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
    - restore_cache:
        key: nerves/deploy/nerves_toolchain_mipsel_unknown_linux_musl/linux-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
    - restore_cache:
        key: nerves/deploy/nerves_toolchain_mipsel_unknown_linux_musl/rpi-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
    - restore_cache:
        key: nerves/deploy/nerves_toolchain_x86_64_unknown_linux_gnu/linux-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
    - restore_cache:
        key: nerves/deploy/nerves_toolchain_x86_64_unknown_linux_gnu/rpi-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
    - restore_cache:
        key: nerves/deploy/nerves_toolchain_x86_64_unknown_linux_musl/linux-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
    - restore_cache:
        key: nerves/deploy/nerves_toolchain_x86_64_unknown_linux_musl/rpi-{{ .Revision }}-{{ .Environment.CIRCLE_TAG }}
    - run:
        name: Copy Artifacts
        command: cp /home/nerves/deploy/toolchain/*/*/*.tar.xz /home/nerves/deploy/artifacts
    - run:
        name: Install dependencies
        command: |
          wget https://github.com/tcnksm/ghr/releases/download/v0.5.4/ghr_v0.5.4_linux_amd64.zip
          unzip ghr_v0.5.4_linux_amd64.zip
    - run:
        name: "Create Release Notes"
        command: grep -Pazo "(?s)(?<=## ${CIRCLE_TAG})[^#]+" ./CHANGELOG.md > /home/nerves/deploy/RELEASE_NOTES
    - run:
        name: Deploy artifacts to Github
        command: ./ghr -draft -t $GITHUB_TOKEN -u $CIRCLE_PROJECT_USERNAME -r $CIRCLE_PROJECT_REPONAME -b "$(cat /home/nerves/deploy/RELEASE_NOTES)" $CIRCLE_TAG /home/nerves/deploy/artifacts

workflows:
  version: 2
  build_deploy:
    jobs:
      #-------------------------------
      # aarch64_unknown_linux_gnueabi
      #-------------------------------
      - build_linux_nerves_toolchain_aarch64_unknown_linux_gnueabi:
          <<: *build_workflow
      - build_rpi_nerves_toolchain_aarch64_unknown_linux_gnueabi:
          <<: *build_workflow
            
      #-------------------------------
      # arm_unknown_linux_gnueabihf
      #-------------------------------
      - build_linux_nerves_toolchain_arm_unknown_linux_gnueabihf:
          <<: *build_workflow
      - build_rpi_nerves_toolchain_arm_unknown_linux_gnueabihf:
          <<: *build_workflow

      #-------------------------------
      # armv5tejl_unknown_linux_musleabi
      #-------------------------------
      - build_linux_nerves_toolchain_armv5tejl_unknown_linux_musleabi:
          <<: *build_workflow
      - build_rpi_nerves_toolchain_armv5tejl_unknown_linux_musleabi:
          <<: *build_workflow

      #-------------------------------
      # armv6_rpi_linux_gnueabi
      #-------------------------------
      - build_linux_nerves_toolchain_armv6_rpi_linux_gnueabi:
          <<: *build_workflow
      - build_rpi_nerves_toolchain_armv6_rpi_linux_gnueabi:
          <<: *build_workflow
            
      #-------------------------------
      # i586_unknown_linux_gnu
      #-------------------------------
      - build_linux_nerves_toolchain_i586_unknown_linux_gnu:
          <<: *build_workflow
      - build_rpi_nerves_toolchain_i586_unknown_linux_gnu:
          <<: *build_workflow
            
      #-------------------------------
      # mipsel_unknown_linux_musl
      #-------------------------------
      - build_linux_nerves_toolchain_mipsel_unknown_linux_musl:
          <<: *build_workflow
      - build_rpi_nerves_toolchain_mipsel_unknown_linux_musl:
          <<: *build_workflow
            
      #-------------------------------
      # x86_64_unknown_linux_gnu
      #-------------------------------
      - build_linux_nerves_toolchain_x86_64_unknown_linux_gnu:
          <<: *build_workflow
      - build_rpi_nerves_toolchain_x86_64_unknown_linux_gnu:
          <<: *build_workflow

      #-------------------------------
      # x86_64_unknown_linux_musl
      #-------------------------------
      - build_linux_nerves_toolchain_x86_64_unknown_linux_musl:
          <<: *build_workflow
      - build_rpi_nerves_toolchain_x86_64_unknown_linux_musl:
          <<: *build_workflow
      
      #-------------------------------
      # Deploy Toolchains
      #-------------------------------
      - deploy:
          <<: *deploy_workflow
          requires:
            - build_linux_nerves_toolchain_aarch64_unknown_linux_gnueabi
            - build_rpi_nerves_toolchain_aarch64_unknown_linux_gnueabi
            - build_linux_nerves_toolchain_arm_unknown_linux_gnueabihf
            - build_rpi_nerves_toolchain_arm_unknown_linux_gnueabihf
            - build_linux_nerves_toolchain_armv5tejl_unknown_linux_musleabi
            - build_rpi_nerves_toolchain_armv5tejl_unknown_linux_musleabi
            - build_linux_nerves_toolchain_armv6_rpi_linux_gnueabi
            - build_rpi_nerves_toolchain_armv6_rpi_linux_gnueabi
            - build_linux_nerves_toolchain_i586_unknown_linux_gnu
            - build_rpi_nerves_toolchain_i586_unknown_linux_gnu
            - build_linux_nerves_toolchain_mipsel_unknown_linux_musl
            - build_rpi_nerves_toolchain_mipsel_unknown_linux_musl
            - build_linux_nerves_toolchain_x86_64_unknown_linux_gnu
            - build_rpi_nerves_toolchain_x86_64_unknown_linux_gnu
            - build_linux_nerves_toolchain_x86_64_unknown_linux_musl
            - build_rpi_nerves_toolchain_x86_64_unknown_linux_musl
